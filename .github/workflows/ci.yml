name: CI

on:
  # allows us to run workflows manually
  workflow_dispatch:

  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  main:
    runs-on: ubuntu-20.04

    steps:
    - uses: actions/checkout@v2

    - name: Prepare Vulkan SDK
      uses: humbletim/setup-vulkan-sdk@v1.2.0
      with:
        vulkan-query-version: 1.3.204.0
        vulkan-components: Vulkan-Headers, Vulkan-Loader
        vulkan-use-cache: true

    - name: Apt dependencies
      shell: bash
      run: |
        sudo apt -y update
        sudo apt install -y xorg-dev \
                            libxinerama-dev \
                            libglu1-mesa-dev \
                            freeglut3-dev \
                            mesa-common-dev

    - name: Setup environment
      shell: bash
      run: |
         echo "PATH=$HOME/dxc-artifacts/bin:$PATH" >> $GITHUB_ENV

    - name: Pull and unpack dxc compiler
      shell: bash
      run: |
        cd $HOME
        wget https://drive.google.com/uc\?export\=download\&id\=1dF6cX5q-3tB3e5zVcZIL_Fa1W8-WRpOq -O dxc-artifacts.tar.gz
        tar xf dxc-artifacts.tar.gz

    - name: Build
      shell: bash
      run: |
        mkdir bld
        cd bld
        cmake .. -DVulkan_BIN_DIR=$HOME/dxc-artifacts/bin
        cmake .. -DVulkan_BIN_DIR=$HOME/dxc-artifacts/bin
        make VERBOSE=1 -j4

    # Just checking build until a CPU backend is ready
    # - name: Run Samples
    #   shell: bash
    #   run: |
    #     cd bld
    #     ./sample00_rayGenOnly
    #     ./sample01_simpleTriangles
