name: CI

on:
  # allows us to run workflows manually
  workflow_dispatch:

  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  ubuntu:
    runs-on: ubuntu-20.04

    steps:
    - uses: actions/checkout@v2

    - name: Prepare Vulkan SDK
      uses: humbletim/setup-vulkan-sdk@v1.2.0
      with:
        vulkan-query-version: 1.3.204.0
        vulkan-components: Vulkan-Headers, Vulkan-Loader
        vulkan-use-cache: true

    - name: Apt dependencies
      shell: bash
      run: |
        sudo apt -y update
        sudo apt install -y xorg-dev \
                            libxinerama-dev \
                            libglu1-mesa-dev \
                            freeglut3-dev \
                            mesa-common-dev

    - name: Setup environment
      shell: bash
      run: |
         echo "PATH=$HOME/dxc-artifacts/bin:$PATH" >> $GITHUB_ENV

    - name: Pull and unpack dxc compiler
      shell: bash
      run: |
        ./util/download-dxc.sh

    - name: Build Static
      shell: bash
      run: |
        mkdir bld-static
        cd bld-static
        cmake --version
        cmake .. -DVulkan_BIN_DIR=$HOME/dxc-artifacts/bin
        make VERBOSE=1 -j4

    - name: Build Shared
      shell: bash
      run: |
        mkdir bld-shared
        cd bld-shared
        cmake --version
        cmake .. -DVulkan_BIN_DIR=$HOME/dxc-artifacts/bin \
                 -DGPRT_BUILD_SHARED=ON
        make VERBOSE=1 -j4


  windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2

    - name: Prepare Vulkan SDK
      uses: humbletim/setup-vulkan-sdk@v1.2.0
      with:
        vulkan-query-version: 1.3.204.0
        vulkan-components: Vulkan-Headers, Vulkan-Loader
        vulkan-use-cache: true

    - name: Pull and unpack dxc compiler
      run: |
        cd $HOME
        C:\msys64\usr\bin\wget.exe https://anl.box.com/shared/static/63jh85qcoedxi4hi84lizp9e0c9h0jo5.zip -O dxc-artifacts.zip
        unzip dxc-artifacts


    - name: Build
      shell: bash
      run: |
        mkdir bld
        cd bld
        cmake --version
        cmake .. -DVulkan_BIN_DIR=$HOME/bin
        cmake --build .

  documentation:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-20.04
    
    steps:  
    - uses: actions/checkout@v3
    
    - name: Prepare Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip' # caching pip dependencies
    - run: pip install -r requirements.txt
    
    - name: Prepare Vulkan SDK
      uses: humbletim/setup-vulkan-sdk@v1.2.0
      with:
        vulkan-query-version: 1.3.204.0
        vulkan-components: Vulkan-Headers, Vulkan-Loader
        vulkan-use-cache: true

    - name: Apt dependencies
      shell: bash
      run: |
        sudo apt -y update
        sudo apt install -y xorg-dev \
                            libxinerama-dev \
                            libglu1-mesa-dev \
                            freeglut3-dev \
                            mesa-common-dev \
                            doxygen
    - name: Setup environment
      shell: bash
      run: |
         echo "PATH=$HOME/dxc-artifacts/bin:$PATH" >> $GITHUB_ENV
    - name: Pull and unpack dxc compiler
      shell: bash
      run: |
        ./util/download-dxc.sh
    - name: Build Documentation
      shell: bash
      run: |
        mkdir bld
        cd bld
        cmake --version
        cmake .. -DVulkan_BIN_DIR=$HOME/dxc-artifacts/bin -DBUILD_DOC=ON
        cmake --build . --target sphinx --config Release
    - name: Setup Pages
      uses: actions/configure-pages@v2
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v1
      with:
        # Upload entire repository
        path: '${GITHUB_WORKSPACE}/GPRT/bld/html'
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v1
